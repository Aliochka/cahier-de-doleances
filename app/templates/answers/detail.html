{% extends "base/base.html" %}

{# Meta #}
{% set _author_label = (answer.author_name or ('Auteur #' ~ answer.author_id)) %}
{% set PAGE_TITLE = "Réponse à « " ~ (answer.question_prompt or ("Question #" ~ answer.question_id)) ~ " »" %}

{# Utilise la fonction helper pour générer un extrait propre #}
{% set _clean_excerpt = answer.text | clean_text_excerpt(180) %}
{% set PAGE_DESCRIPTION = (_clean_excerpt if _clean_excerpt else "Lisez l'avis et les arguments détaillés de " ~ _author_label ~ ".") %}

{# URL canonique sans paramètres #}
{% set CANONICAL_URL = url_for('answer_detail', answer_id=answer.id) | string %}

{# Image OG dynamique #}
{% set OG_IMAGE_URL = url_for('og_answer_image', answer_id=answer.id) %}

{% block content %}

  {# URLs canoniques #}
  {% set q_url = url_for('question_detail', question_id=answer.question_id, slug=answer.question_slug) %}
  {% if answer.author_id %}
    {% set author_url = url_for('author_detail', author_id=answer.author_id, slug=answer.author_slug) %}
  {% endif %}

  <header class="page-header page-header--stack">
    <h1 class="h1">
      <a href="{{ q_url }}">{{ answer.question_prompt }}</a>
    </h1>
    <p class="muted">
      par
      {% if answer.author_id and author_url is defined %}
        <a href="{{ author_url }}">
          {{ answer.author_name or ('Auteur #' ~ answer.author_id) }}
        </a>
      {% else %}
        {{ answer.author_name or 'Auteur anonyme' }}
      {% endif %}
      {% if answer.submitted_at %} — {{ answer.submitted_at }}{% endif %}
    </p>
  </header>

  <section class="answer-page">
    <article class="answer answer--full">
      <blockquote class="quote">
        <p class="quote__text">{{ answer.text }}</p>
      </blockquote>
    </article>
  </section>
{% endblock %}

{% block jsonld %}
{% set _author = (answer.author_name or ("Auteur #" ~ answer.author_id)) %}
{% set _headline = (answer.question_prompt or ("Question #" ~ answer.question_id)) %}
{% set _article_body = (answer.text | striptags) %}
{% set _q_url = url_for('question_detail', question_id=answer.question_id, slug=answer.question_slug) %}

{# Construire l'objet puis le sérialiser #}
{% set _json = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": _headline,
  "mainEntityOfPage": request.url,
  "articleBody": _article_body,
  "datePublished": (answer.submitted_at or ""),
  "author": { "@type": "Person", "name": _author },
  "about": { "@type": "Question", "name": _headline, "url": _q_url }
} %}
<script type="application/ld+json">{{ _json | tojson | safe }}</script>
{% endblock %}
