{% if questions and questions|length %}
{# Script de nettoyage pour éviter les doublons #}
<script>
// Supprimer tous les anciens sentinels avant d'ajouter le nouveau
(function() {
  const oldQuestionsSentinels = document.querySelectorAll('#questions-list .htmx-sentinel');
  oldQuestionsSentinels.forEach(s => s.remove());
})();
</script>

  <ul class="list list--plain">
    {% for question in questions %}
      <li class="card">
        {% with q=question %}
          {% include "questions/_card.html" %}
        {% endwith %}
      </li>
    {% endfor %}
  </ul>

  {% if has_next_questions and next_cursor_questions %}
    <div class="htmx-sentinel" id="questions-sentinel"
         data-url="{{ url_for('search_questions') }}?partial=1&section=questions{% if q %}&q={{ q|urlencode }}{% endif %}&cursor_questions={{ next_cursor_questions|urlencode }}">
      <div class="list-loader">
        <div class="loader" title="Chargement des questions suivantes…"></div>
        <span style="margin-left: var(--space-2); color: var(--muted);">Chargement des questions…</span>
      </div>
    </div>

    <script>
    // Intersection Observer pour scroll infini
    (function() {
      const sentinel = document.getElementById('questions-sentinel');
      if (!sentinel) return;
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !sentinel.dataset.loaded) {
            // Scroll infini déclenché pour questions
            sentinel.dataset.loaded = 'true';
            
            // Déclencher la requête HTMX manuellement
            htmx.ajax('GET', sentinel.dataset.url, {
              target: '#questions-list',
              swap: 'beforeend'
            }).then(() => {
              // Supprimer cet ancien sentinel après succès
              sentinel.remove();
            });
          }
        });
      }, { threshold: 0.1 });
      
      observer.observe(sentinel);
    })();
    </script>
  {% endif %}
{% else %}
  {% include "partials/_empty_state.html" %}
{% endif %}
